<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JINIHOME | Luxury Archive</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        /* 1. CORE SETTINGS */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        :root {
            /* DYNAMIC DASHBOARD COLORS (Defaults) */
            --header-bg: #002fa7; 
            --header-text: #ffffff;
            --body-bg: #ffffff;
            --body-vignette: #ccff00; 
        }

        body {
            font-family: 'Manrope', sans-serif;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            background: var(--body-bg);
        }

        /* 2. ZONES */
        .zone-header {
            background-color: var(--header-bg);
            color: var(--header-text);
            transition: background 0.5s ease;
            position: relative;
        }

        .zone-body {
            /* Vignette Effect */
            background: radial-gradient(circle at 50% 30%, var(--body-bg) 20%, var(--body-vignette) 150%);
            min-height: 100vh;
            color: #000;
            position: relative;
            z-index: 10;
        }

        /* 3. BIGGER COLLECTIONS */
        .collection-track-wrapper {
            display: flex;
            justify-content: center; /* Centers the list if it fits on screen */
            width: 100%;
        }

        .collection-track {
            display: flex;
            gap: 2rem;
            overflow-x: auto;
            padding-bottom: 2rem;
            width: 100%;
            /* Safe centering logic for scrollable areas */
            justify-content: flex-start; 
        }
        @media (min-width: 768px) {
            .collection-track { justify-content: center; } /* Center on desktop usually fits */
        }

        .collection-circle {
            width: 140px; height: 140px; /* CONSISTENT SIZE */
            border-radius: 50%;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(0,0,0,0.1);
        }

        .collection-item.active .collection-circle {
            border-color: #000;
            transform: scale(1.1);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        /* 4. UTILS */
        .intro-curtain { position: fixed; inset: 0; z-index: 10000; background: #050505; flex-direction: column; justify-content: space-between; padding: 2rem; display: flex; }
        .lux-label { font-size: 10px; letter-spacing: 0.3em; text-transform: uppercase; font-weight: 700; opacity: 0.6; }
        .float-anim { animation: float 6s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>

<body>

    <div id="intro-screen" class="intro-curtain">
        <div class="flex justify-between items-start w-full opacity-0 intro-reveal">
            <div><p class="lux-label text-white/50 mb-1">Origin</p><p id="intro-loc" class="text-xs text-white uppercase tracking-widest">Loading...</p></div>
            <div class="text-right"><p class="lux-label text-white/50 mb-1">Philosophy</p><p id="intro-desc" class="text-xs text-white/80 italic">Archive...</p></div>
        </div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center w-full">
            <h1 id="intro-title" class="text-[12vw] font-bold tracking-tighter text-white opacity-0 uppercase mix-blend-difference">JINIHOME</h1>
        </div>
        <div class="w-full opacity-0 intro-reveal">
            <div class="h-[1px] w-full bg-white/20 relative"><div id="load-bar" class="absolute top-0 left-0 h-full w-0 bg-white"></div></div>
        </div>
    </div>

    <div id="app-content" style="opacity: 0;">
        
        <div class="zone-header">
            <nav class="fixed top-0 w-full z-50 px-6 h-24 flex justify-between items-center mix-blend-difference text-white">
                <div class="flex items-center gap-4">
                    <img id="nav-logo" src="" class="h-6 w-auto hidden brightness-0 invert">
                    <span id="nav-text" class="text-xl font-bold tracking-tighter uppercase">JINIHOME</span>
                </div>
                <button onclick="toggleCart()" class="flex items-center gap-3">
                    <span class="lux-label text-white hidden md:block">Bag</span>
                    <div id="cart-count" class="w-8 h-8 bg-white text-black flex items-center justify-center text-xs font-bold rounded-full">0</div>
                </button>
            </nav>

            <header class="min-h-[65vh] flex flex-row items-center justify-between px-6 md:px-24 pt-32 pb-20">
                <div class="w-1/2 z-10 pr-4">
                    <p class="lux-label text-white mb-6 border-l-2 border-white pl-4">Establishment 2026</p>
                    <h1 class="text-[9vw] md:text-[9vw] font-bold uppercase tracking-tighter leading-[0.8] mb-10">
                        Prime <br><span class="font-light italic opacity-60">Archive</span>
                    </h1>
                    <button onclick="document.getElementById('zone-shop').scrollIntoView({behavior:'smooth'})" class="bg-white text-black px-6 md:px-10 py-3 md:py-4 text-[9px] md:text-[10px] font-bold uppercase tracking-[0.3em] hover:bg-opacity-90 transition-all">
                        Enter Vault
                    </button>
                </div>
                <div class="w-1/2 flex justify-center">
                    <div class="w-full max-w-[450px] aspect-[3/4] border-2 border-white/20 relative overflow-hidden shadow-2xl float-anim rounded-t-full">
                        <img src="https://images.unsplash.com/photo-1515886657613-9f3515b0c78f?q=80&w=1000" class="w-full h-full object-cover">
                    </div>
                </div>
            </header>
        </div>

        <div id="zone-shop" class="zone-body rounded-t-[3rem] -mt-12 pt-24 px-4 md:px-12 border-t border-white/50 shadow-[0_-20px_40px_rgba(0,0,0,0.05)]">
            
            <div class="mb-20 text-center">
                <div class="mb-10">
                    <p class="lux-label text-black/40 mb-2">Departments</p>
                    <h2 class="text-2xl font-bold uppercase tracking-tight">Select Category</h2>
                </div>
                
                <div class="collection-track-wrapper">
                    <div id="collection-track" class="collection-track no-scrollbar">
                        </div>
                </div>
            </div>

            <div class="min-h-screen px-2 md:px-12">
                <div class="mb-12 flex items-baseline justify-between border-b border-black/10 pb-4">
                    <h2 id="grid-title" class="text-4xl md:text-5xl font-bold tracking-tighter uppercase">All Items</h2>
                    <p id="grid-count" class="lux-label text-black">Loading...</p>
                </div>
                <div id="product-grid" class="grid grid-cols-2 gap-x-4 gap-y-16"></div>
            </div>

            <footer class="py-32 text-center opacity-50">
                <h2 id="footer-logo" class="text-[10vw] font-bold tracking-tighter uppercase opacity-20">JINIHOME</h2>
                <p class="lux-label mt-8">© 2026 Global Archive System</p>
            </footer>
        </div>

    </div>

    <div id="cart-sidebar" class="fixed inset-y-0 right-0 w-full md:w-[450px] bg-white z-[60] transform translate-x-full transition-transform duration-500 border-l border-black/10 flex flex-col shadow-2xl">
        <div class="p-8 flex justify-between items-center border-b border-black/5 bg-gray-50">
            <h3 class="font-bold text-xl uppercase tracking-tighter">Your Bag</h3>
            <button onclick="toggleCart()" class="text-2xl">✕</button>
        </div>
        <div id="cart-items" class="flex-1 overflow-y-auto p-8 space-y-6"></div>
        <div class="p-8 border-t border-black/5">
            <div class="flex justify-between text-xl font-bold mb-6"><span>Total</span><span id="cart-total">$0.00</span></div>
            <button onclick="checkoutWhatsApp()" class="w-full py-6 bg-black text-white font-bold uppercase tracking-[0.3em]">Checkout</button>
        </div>
    </div>

    
     <script>
        const SUPABASE_URL = 'https://rujozgysdnaxlpqadqff.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1am96Z3lzZG5heGxwcWFkcWZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0OTY1MTUsImV4cCI6MjA4NTA3MjUxNX0.zi4FwC0xfq0brTrYs3i18rwO3hbFeVhDBq6TpLQCyVs';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let products = [], collections = [], cart = [], profile = {};
        
        // --- THE TRANSLATOR ---
        // This dictionary will map ID numbers (e.g. 123) to Names (e.g. "Shoes")
        let collectionMap = {}; 

        window.onload = async () => {
            await syncDatabase();
            playIntro();
        };

        async function syncDatabase() {
            try {
                // 1. Slug Logic
                const path = window.location.pathname.replace(/\/+$/, '').split('/').pop();
                let slug = 'yashus'; 
                if(path && path !== 'index' && path !== 'store' && path !== 'null') slug = path;

                // 2. Fetch Profile & Colors
                const { data: prof } = await sb.from('profiles').select('*').eq('store_slug', slug).maybeSingle();
                
                if(prof) {
                    profile = prof;
                    applyDesign();
                    
                    // 3. Fetch Products
                    const { data: prods } = await sb
                        .from('products')
                        .select('*')
                        .eq('user_id', profile.id)
                        .order('created_at', {ascending: false});
                        
                    products = prods || [];
                }

                // 4. Fetch Collections & BUILD TRANSLATOR
                const { data: cols } = await sb
                    .from('collections')
                    .select('*')
                    .order('name');
                    
                collections = cols || [];
                
                // [THE FIX]: Create the ID->Name Map
                // Example: { "a1-b2-c3": "Shoes", "x9-y8-z7": "Watches" }
                collections.forEach(c => {
                    if(c.id) collectionMap[c.id] = c.name;
                });

                // 5. Render
                renderCollections();
                filterGrid('All');

            } catch(e) { 
                console.error("Sync Error:", e); 
                document.getElementById('app-content').style.opacity = 1; 
            }
        }

        function applyDesign() {
            const root = document.documentElement;
            const hColor = profile.header_color || '#002fa7';
            root.style.setProperty('--header-bg', hColor);
            const bColor = profile.body_color || '#ccff00';
            root.style.setProperty('--body-vignette', bColor);

            const name = profile.store_name || "ARCHIVE";
            document.querySelectorAll('#nav-text, #intro-title, #footer-logo').forEach(el => el.innerText = name);
            if(profile.location) document.getElementById('intro-loc').innerText = profile.location;
            if(profile.description) document.getElementById('intro-desc').innerText = profile.description;
            if(profile.logo_url) {
                document.getElementById('nav-logo').src = profile.logo_url;
                document.getElementById('nav-logo').classList.remove('hidden');
            }
        }

        function renderCollections() {
            const track = document.getElementById('collection-track');
            
            // "ALL" Button
            let html = `
                <div class="collection-item active shrink-0 text-center cursor-pointer group" onclick="filterGrid('All', this)">
                    <div class="collection-circle flex items-center justify-center bg-black text-white mb-4 mx-auto">
                        <span class="font-bold text-sm tracking-widest">ALL</span>
                    </div>
                    <p class="lux-label text-black">All Items</p>
                </div>`;

            // Dynamic Items
            html += collections.map(c => {
                const safeName = c.name.replace(/'/g, "\\'");
                return `
                <div class="collection-item shrink-0 text-center cursor-pointer group" onclick="filterGrid('${safeName}', this)">
                    <div class="collection-circle overflow-hidden mb-4 mx-auto bg-white">
                        <img src="${c.img_url}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700" 
                             onerror="this.src='https://placehold.co/300?text=${c.name}'">
                    </div>
                    <p class="lux-label text-gray-500 group-hover:text-black transition-colors">${c.name}</p>
                </div>
            `}).join('');

            track.innerHTML = html;
        }

        function filterGrid(categoryName, element) {
            if(element) {
                document.querySelectorAll('.collection-item').forEach(el => {
                    el.classList.remove('active');
                    el.querySelector('p').classList.replace('text-black', 'text-gray-500');
                });
                element.classList.add('active');
                element.querySelector('p').classList.replace('text-gray-500', 'text-black');
            }

            const target = categoryName.toLowerCase().trim();
            
            // --- THE TRANSLATOR FILTER ---
            const filtered = target === 'all' 
                ? products 
                : products.filter(p => {
                    // 1. Check direct Text Matches (The old way)
                    const textValues = [p.collections, p.collection, p.category, p.categories, p.tags].flat().filter(v => v);
                    const hasTextMatch = textValues.some(val => String(val).toLowerCase().trim() === target);
                    
                    if(hasTextMatch) return true;

                    // 2. Check ID Matches (The new "Foreign Key" fix)
                    // If product has 'collection_id', we convert it to a Name using the map
                    const idValues = [p.collection_id, p.category_id, p.collection].flat().filter(v => v);
                    const hasIdMatch = idValues.some(id => {
                        const mappedName = collectionMap[id]; // Looks up "5" -> "Shoes"
                        return mappedName && mappedName.toLowerCase().trim() === target;
                    });
                    
                    return hasIdMatch;
                });

            document.getElementById('grid-title').innerText = categoryName === 'All' ? 'Full Archive' : categoryName;
            document.getElementById('grid-count').innerText = `${filtered.length} AVAILABLE`;

            const grid = document.getElementById('product-grid');
            
            if(filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full py-20 text-center lux-label opacity-50">No items found in ${categoryName}</div>`;
                return;
            }

            // Helper to get display name for the card
            const getCatName = (p) => {
                // Try text first
                if(p.collections) return p.collections;
                if(p.category) return p.category;
                // Try ID lookup second
                if(p.collection_id && collectionMap[p.collection_id]) return collectionMap[p.collection_id];
                return 'Archive';
            };

            grid.innerHTML = filtered.map(p => `
                <div class="group cursor-pointer" onclick='addToCart(${JSON.stringify(p).replace(/'/g, "&#39;")})'>
                    <div class="aspect-[3/4] overflow-hidden rounded-lg mb-4 bg-white relative shadow-sm">
                        <img src="${p.images ? p.images[0] : ''}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700">
                        <div class="absolute bottom-0 left-0 w-full p-3 bg-white/90 backdrop-blur opacity-0 group-hover:opacity-100 transition-opacity flex justify-between items-center">
                            <span class="text-[9px] font-bold uppercase tracking-widest">Add</span>
                            <span class="text-xs font-bold">$${p.price}</span>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-bold text-sm uppercase tracking-tight leading-none mb-1">${p.name}</h4>
                        <p class="lux-label">${getCatName(p)}</p>
                    </div>
                </div>
            `).join('');

            gsap.fromTo(".group", { y: 20, opacity: 0 }, { y: 0, opacity: 1, duration: 0.5, stagger: 0.05 });
        }

        function playIntro() {
            const tl = gsap.timeline({
                onComplete: () => {
                    document.getElementById('app-content').style.opacity = 1;
                    setTimeout(() => document.getElementById('intro-screen').style.display = 'none', 1000);
                }
            });
            tl.to(".intro-reveal", { opacity: 1, y: 0, duration: 1, stagger: 0.2 })
              .to("#load-bar", { width: "100%", duration: 1.5, ease: "power2.inOut" })
              .to("#intro-title", { opacity: 1, duration: 1 }, "-=1")
              .to("#intro-screen", { y: "-100%", duration: 1.2, ease: "expo.inOut", delay: 0.5 });
        }

        function addToCart(p) { cart.push(p); updateCart(); toggleCart(); }
        function updateCart() {
            const cont = document.getElementById('cart-items');
            let total = 0;
            cont.innerHTML = cart.map((item, i) => {
                total += parseFloat(item.price || 0);
                return `<div class="flex gap-4 border-b pb-4"><img src="${item.images[0]}" class="w-12 h-16 object-cover"><div class="flex-1"><p class="font-bold text-sm">${item.name}</p><p class="text-xs text-gray-500">$${item.price}</p><button onclick="cart.splice(${i},1);updateCart()" class="text-[9px] underline mt-1">REMOVE</button></div></div>`;
            }).join('');
            document.getElementById('cart-total').innerText = '$' + total.toFixed(2);
            document.getElementById('cart-count').innerText = cart.length;
        }
        function toggleCart() { document.getElementById('cart-sidebar').classList.toggle('translate-x-full'); }
        function checkoutWhatsApp() { window.open(`https://wa.me/${profile.payment_number || '9199999999'}?text=Order:${cart.map(i=>i.name).join(',')}`, '_blank'); }
    </script>
    
</body>
</html>
