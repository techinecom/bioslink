<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BiosSTORE | Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700;800&display=swap');
        
        :root { --lime: #D9FF00; --blue: #0047FF; --yellow: #FFD600; }

        body { 
            font-family: 'Space Grotesk', sans-serif; 
            background: #000; color: #fff; overflow-x: hidden; min-height: 100vh;
            display: flex; align-items: center; justify-content: center;
        }

        /* --- BACKGROUND CORE --- */
        .core-glow {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 100vw; height: 100vw; max-width: 800px;
            background: radial-gradient(circle, rgba(0,71,255,0.12) 0%, transparent 70%);
            z-index: -1; animation: pulseCore 6s infinite ease-in-out;
        }
        @keyframes pulseCore { 0%, 100% { opacity: 0.3; transform: translate(-50%, -50%) scale(1); } 50% { opacity: 0.7; transform: translate(-50%, -50%) scale(1.3); } }

        /* --- ATM CARD (Front Page 3x3 Grid) --- */
        .atm-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.08), rgba(255,255,255,0.01));
            border: 1px solid rgba(255,255,255,0.1); border-radius: 28px; 
            padding: 30px; transition: all 0.4s ease;
            backdrop-filter: blur(20px); display: flex; flex-direction: column; position: relative;
        }
        .atm-card:hover:not(.locked) {
            transform: translateY(-8px); border-color: var(--lime);
            box-shadow: 0 20px 40px rgba(0,0,0,0.6), 0 0 20px rgba(217, 255, 0, 0.1);
        }

        .locked { border-color: rgba(255, 214, 0, 0.1); opacity: 0.4; cursor: not-allowed; filter: grayscale(1); }
        .locked-tag { font-size: 8px; font-weight: 900; background: var(--yellow); color: #000; padding: 3px 10px; border-radius: 4px; position: absolute; top: 20px; right: 20px; }

        /* --- CLEAN INPUT CARD --- */
        .input-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 32px;
            padding: 40px;
            box-shadow: 0 40px 100px rgba(0,0,0,0.4);
            backdrop-filter: blur(30px);
        }

        /* --- SWIPEABLE PLAN SECTION (Mobile Only) --- */
        @media (max-width: 768px) {
            .plan-scroller {
                display: flex;
                overflow-x: auto;
                scroll-snap-type: x mandatory;
                gap: 20px;
                padding: 20px 0;
                -webkit-overflow-scrolling: touch;
            }
            .plan-scroller .atm-card {
                min-width: 85%;
                scroll-snap-align: center;
                height: auto;
            }
            .plan-scroller::-webkit-scrollbar { display: none; }
        }

        .step-view { display: none; width: 100%; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .step-view.active { display: block; animation: slideIn 0.5s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .cyber-input {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            padding: 20px; border-radius: 18px; color: #fff; outline: none; transition: 0.3s;
        }
        .cyber-input:focus { border-color: var(--blue); background: rgba(255,255,255,0.1); box-shadow: 0 0 20px rgba(0, 71, 255, 0.2); }

        .feature-item { font-size: 14px; color: rgba(255,255,255,0.6); display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .feature-item i { color: var(--lime); }
        
        #sync-overlay {
            display: none; position: fixed; inset: 0; background: #000; z-index: 9999;
            flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body class="p-4">

    <div id="sync-overlay">
        <div class="w-16 h-16 border-4 border-lime border-t-transparent rounded-full animate-spin mb-6"></div>
        <h2 class="text-lime font-bold tracking-[0.5em] uppercase text-xs">Directing to Core...</h2>
    </div>

    <div class="core-glow"></div>

    <div id="step-1" class="step-view active">
        <div class="text-center mb-12">
            <h1 class="text-5xl md:text-7xl font-black tracking-tighter uppercase italic">Initialize <span class="text-lime">Sector</span></h1>
            <p class="text-white/30 text-[10px] uppercase tracking-[0.4em] mt-4">Select operational module to begin</p>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
            <div class="atm-card" onclick="next(2, 'SELLER')">
                <div class="w-10 h-6 bg-white/10 rounded-md mb-8"></div>
                <i class="fa-solid fa-shop text-4xl mb-4 text-lime"></i>
                <h3 class="text-2xl font-black uppercase italic">Seller</h3>
                <p class="text-[9px] opacity-40 uppercase tracking-widest mt-auto">Hardware: Active</p>
            </div>
            <div class="atm-card" onclick="next(2, 'KITCHEN')">
                <div class="w-10 h-6 bg-white/10 rounded-md mb-8"></div>
                <i class="fa-solid fa-fire-burner text-4xl mb-4 text-lime"></i>
                <h3 class="text-2xl font-black uppercase italic">Kitchen</h3>
                <p class="text-[9px] opacity-40 uppercase tracking-widest mt-auto">Hardware: Active</p>
            </div>
            <div class="atm-card" onclick="next(2, 'EVENTS')">
                <div class="w-10 h-6 bg-white/10 rounded-md mb-8"></div>
                <i class="fa-solid fa-ticket text-4xl mb-4 text-lime"></i>
                <h3 class="text-2xl font-black uppercase italic">Events</h3>
                <p class="text-[9px] opacity-40 uppercase tracking-widest mt-auto">Hardware: Active</p>
            </div>
            <div class="atm-card locked">
                <span class="locked-tag">COMING SOON</span>
                <i class="fa-solid fa-wand-magic-sparkles text-4xl mb-4 text-yellow-500"></i>
                <h3 class="text-2xl font-black uppercase italic">Creators</h3>
            </div>
            <div class="atm-card locked">
                <span class="locked-tag">COMING SOON</span>
                <i class="fa-solid fa-user-tie text-4xl mb-4 text-yellow-500"></i>
                <h3 class="text-2xl font-black uppercase italic">Consultants</h3>
            </div>
            <div class="atm-card locked">
                <span class="locked-tag">COMING SOON</span>
                <i class="fa-solid fa-screwdriver-wrench text-4xl mb-4 text-yellow-500"></i>
                <h3 class="text-2xl font-black uppercase italic">Services</h3>
            </div>
        </div>
    </div>

    <div id="step-2" class="step-view max-w-xl">
        <div class="input-card">
            <h2 class="text-3xl font-black mb-2 italic uppercase text-blue-500">Verify <span class="text-white">ID</span></h2>
            <p class="text-white/40 text-[10px] uppercase tracking-widest mb-10">Unique terminal address</p>
            <div class="space-y-6">
                <input type="text" id="handle" class="cyber-input text-2xl font-bold uppercase tracking-widest" placeholder="STORE NAME" oninput="checkName(this.value)">
                <div id="feedback" class="h-6 font-bold text-[10px] tracking-[0.2em] uppercase"></div>
                <button id="btn2" class="w-full bg-white text-black py-6 rounded-2xl font-black uppercase text-lg opacity-20 pointer-events-none transition-all" onclick="next(3)">Sync Identity</button>
            </div>
        </div>
    </div>

    <div id="step-3" class="step-view max-w-3xl">
        <div class="input-card">
            <h2 class="text-3xl font-black mb-10 italic uppercase text-lime">Merchant <span class="text-white">Specs</span></h2>
            <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
                <div class="md:col-span-4 flex justify-center">
                    <div class="w-40 h-40 rounded-3xl border-2 border-dashed border-white/20 flex flex-col items-center justify-center hover:border-lime cursor-pointer bg-white/5 transition-all">
                        <i class="fa-solid fa-camera text-2xl mb-2"></i>
                        <span class="text-[9px] font-black uppercase">Brand Logo</span>
                    </div>
                </div>
                <div class="md:col-span-8 space-y-5">
                    <input type="text" id="final-name" class="cyber-input font-black text-blue-500 border-blue-500/30" readonly>
                    <textarea id="desc" class="cyber-input h-24" placeholder="DESCRIPTION (What do you sell?)"></textarea>
                    <textarea id="addr" class="cyber-input h-24" placeholder="OFFICIAL ADDRESS"></textarea>
                    <button class="w-full bg-blue-600 py-6 rounded-2xl font-black uppercase text-lg" onclick="next(4)">Choose Tier</button>
                </div>
            </div>
        </div>
    </div>

    <div id="step-4" class="step-view">
        <div class="text-center mb-10">
            <h1 class="text-4xl md:text-7xl font-black tracking-tighter uppercase italic text-lime">Choose <span class="text-white">Plan</span></h1>
            <p class="md:hidden text-white/40 text-[9px] uppercase tracking-widest mt-2">Swipe left or right to view</p>
        </div>
        
        <div class="plan-scroller grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="atm-card border-white/10" onclick="saveToFirebase('FREE')">
                <div class="mb-10">
                    <h3 class="text-3xl font-black mb-2 uppercase italic text-white/40">Free</h3>
                    <div class="text-6xl font-black">₹0</div>
                </div>
                <div class="space-y-4 mb-10 border-t border-white/10 pt-8">
                    <div class="feature-item"><i class="fa-solid fa-check"></i> 5 Product Listings</div>
                    <div class="feature-item"><i class="fa-solid fa-check"></i> 5% Transaction Fee</div>
                    <div class="feature-item opacity-20"><i class="fa-solid fa-xmark"></i> No Custom Domain</div>
                </div>
                <button class="w-full py-5 rounded-2xl border border-white/20 font-black uppercase text-xs mt-auto">Select Basic</button>
            </div>
            
            <div class="atm-card border-blue-600 bg-blue-600/10 lg:scale-105 shadow-[0_0_60px_rgba(0,71,255,0.2)]" onclick="saveToFirebase('BASIC')">
                <div class="mb-10">
                    <h3 class="text-3xl font-black mb-2 uppercase italic text-blue-400">Basic</h3>
                    <div class="text-6xl font-black">₹999</div>
                </div>
                <div class="space-y-4 mb-10 border-t border-white/10 pt-8">
                    <div class="feature-item"><i class="fa-solid fa-check"></i> Unlimited Listings</div>
                    <div class="feature-item"><i class="fa-solid fa-check"></i> 2% Transaction Fee</div>
                    <div class="feature-item"><i class="fa-solid fa-check"></i> Growth Dashboard</div>
                </div>
                <button class="w-full py-5 rounded-2xl bg-blue-600 font-black uppercase text-xs mt-auto">Select Growth</button>
            </div>
            
            <div class="atm-card border-lime" onclick="saveToFirebase('ELITE')">
                <div class="mb-10">
                    <h3 class="text-3xl font-black mb-2 uppercase italic text-lime">Elite</h3>
                    <div class="text-6xl font-black">₹2499</div>
                </div>
                <div class="space-y-4 mb-10 border-t border-white/10 pt-8">
                    <div class="feature-item"><i class="fa-solid fa-check"></i> 0% Commission</div>
                    <div class="feature-item"><i class="fa-solid fa-check"></i> Custom .shop Domain</div>
                    <div class="feature-item"><i class="fa-solid fa-check"></i> Priority Payouts</div>
                </div>
                <button class="w-full py-5 rounded-2xl bg-lime text-black font-black uppercase text-xs mt-auto">Select Elite</button>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDMm_iqFWeU_jv_y-tHhRA-lZhy5PosQnI",
        authDomain: "seller-bio.firebaseapp.com",
        projectId: "seller-bio",
        storageBucket: "seller-bio.firebasestorage.app",
        messagingSenderId: "319004958530",
        appId: "1:319004958530:web:6ba52f7ec5cb06e34872db"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loader = document.getElementById('loader-wrapper');
    const statusText = document.getElementById('status-text');

    // 1. Setup State Tracking
let currentStep = 1;
const totalSteps = 3; // Adjust based on your actual step count

// 2. Function to Update the UI
function showStep(stepNumber) {
    // Hide all steps
    document.querySelectorAll('.step-container').forEach(el => el.style.display = 'none');
    
    // Show the target step
    const targetStep = document.getElementById(`step-${stepNumber}`);
    if (targetStep) {
        targetStep.style.display = 'block';
        currentStep = stepNumber;
    }
}

// 3. The "Next" Button Logic
window.goToNextStep = () => {
    if (currentStep < totalSteps) {
        currentStep++;
        // This line tells the browser: "We are moving forward, remember this!"
        history.pushState({ step: currentStep }, `Step ${currentStep}`, `#step${currentStep}`);
        showStep(currentStep);
    }
};

// 4. The "Magic" Back Button Listener
window.addEventListener('popstate', (event) => {
    // If the user hit 'Back' and we have a step saved in history...
    if (event.state && event.state.step) {
        showStep(event.state.step);
    } else {
        // If they back out of Step 1, let them go back to the Login/Index
        showStep(1);
    }
});

// 5. Initialize the first state
window.addEventListener('load', () => {
    history.replaceState({ step: 1 }, "Step 1", "#step1");
});
    
    // --- 1. LOADER CONTROLS ---
    const showLoader = (msg) => {
        loader.style.display = 'flex';
        loader.style.opacity = '1';
        statusText.innerText = msg;
    };

    const hideLoader = () => {
        loader.style.opacity = '0';
        setTimeout(() => { loader.style.display = 'none'; }, 500);
    };

    // --- 2. BACK BUTTON / PERSISTENCE FIX ---
    // This ensures that if the user hits "Back" from the next page, they don't see the loader.
    window.addEventListener('pageshow', (event) => {
        hideLoader();
    });

    window.addEventListener('load', () => {
        setTimeout(hideLoader, 800);
    });

    // --- 3. POST-AUTH ROUTING ---
    async function handlePostAuth(user) {
        showLoader("VERIFYING IDENTITY...");
        try {
            const docRef = doc(db, "merchants", user.uid);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                statusText.innerText = "ACCESS GRANTED";
                window.location.href = 'dashboard.html';
            } else {
                statusText.innerText = "NEW TERMINAL DETECTED";
                window.location.href = 'onboarding.html';
            }
        } catch (error) {
            console.error(error);
            // If we can't check the DB, assume onboarding is needed
            window.location.href = 'onboarding.html';
        }
    }

    // --- 4. GOOGLE LOGIN ---
    document.getElementById('googleLogin').onclick = async () => {
        const provider = new GoogleAuthProvider();
        showLoader("CONTACTING GOOGLE...");
        try {
            const result = await signInWithPopup(auth, provider);
            handlePostAuth(result.user);
        } catch (error) {
            console.warn("Login cancelled or failed:", error.code);
            hideLoader(); // Return to form if they close the popup
        }
    };

    // --- 5. EMAIL LOGIN ---
    document.getElementById('loginBtn').onclick = async () => {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        
        if(!email || !password) return alert("Please enter Access ID and Passkey");

        showLoader("INITIATING SESSION...");
        
        try {
            const result = await signInWithEmailAndPassword(auth, email, password);
            handlePostAuth(result.user);
        } catch (error) {
            hideLoader();
            // Friendly error mapping
            if (error.code === 'auth/invalid-credential') {
                alert("Access Denied: Invalid ID or Passkey.");
            } else {
                alert("Protocol Error: " + error.message);
            }
        }
    };
</script>
</body>
</html>
